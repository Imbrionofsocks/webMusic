<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="../../out/css/milligram.css">
    <link rel="stylesheet" href="../../out/css/mainStyle.css">
</head>
<body>
<div class="popup__bg">
    <form class="popup">
        <div class="playlist-popup-header">
            <label style="margin-left:0.5rem;display: flex">Добавить в плейлист</label>
        </div>
        <div class="track-container" style="display: flex;align-items: center">
            <label style="margin-left:0.5rem;display: flex">Дора</label>
        </div>
        <div class="track-container" style="display: flex;align-items: center">
            <label style="margin-left:0.5rem;display: flex">Дора</label>
        </div>
        <div class="track-container" style="display: flex;align-items: center">
            <label style="margin-left:0.5rem;display: flex">Дора</label>
        </div>
        <div class="track-container" style="display: flex;align-items: center">
            <label style="margin-left:0.5rem;display: flex">Дора</label>
        </div>
        <div class="track-container" style="display: flex;align-items: center">
            <label style="margin-left:0.5rem;display: flex">Дора</label>
        </div>
        <div class="track-container" style="display: flex;align-items: center">
            <label style="margin-left:0.5rem;display: flex">Дора</label>
        </div>
        <div class="track-container" style="display: flex;align-items: center">
            <label style="margin-left:0.5rem;display: flex">Дора</label>
        </div>
        <div class="track-container" style="display: flex;align-items: center">
            <label style="margin-left:0.5rem;display: flex">Дора</label>
        </div>
        <div class="track-container" style="display: flex;align-items: center">
            <label style="margin-left:0.5rem;display: flex">Дора</label>
        </div>
        <div class="track-container" style="display: flex;align-items: center">
            <label style="margin-left:0.5rem;display: flex">Дора</label>
        </div>
        <div class="track-container" style="display: flex;align-items: center">
            <label style="margin-left:0.5rem;display: flex">Дора</label>
        </div>
        <div class="track-container" style="display: flex;align-items: center">
            <label style="margin-left:0.5rem;display: flex">Дора</label>
        </div>
        <div class="track-container" style="display: flex;align-items: center">
            <label style="margin-left:0.5rem;display: flex">Дора</label>
        </div>
        <div class="track-container" style="display: flex;align-items: center">
            <label style="margin-left:0.5rem;display: flex">Дора</label>
        </div>
        <div class="track-container" style="display: flex;align-items: center">
            <label style="margin-left:0.5rem;display: flex">Дора</label>
        </div>
        <div class="track-container" style="display: flex;align-items: center">
            <label style="margin-left:0.5rem;display: flex">Дора</label>
        </div>
        <div class="track-container" style="display: flex;align-items: center">
            <label style="margin-left:0.5rem;display: flex">Дора</label>
        </div>
        <div class="track-container" style="display: flex;align-items: center">
            <label style="margin-left:0.5rem;display: flex">Дора</label>
        </div>
    </form>
</div>
<div class="wrapper">
    <div class="bg-image"></div>
    <div class="main-container" id="mainContainer">
        <div class="header-container">
            <div class="image" id="logoImage"></div>
            <div class="header-search">
                <div class="header-input">
                    <label for="searchInput">
                        <span class="search-title">Поиск</span>
                        <input type="text"
                               placeholder="Введите название трека"
                               id="searchInput">
                        <div class="dropdown-content" id="searchDropdown">
                            <ul id="results-list">
                            </ul>
                        </div>
                    </label>
                </div>
                <div class="user-image"></div>
                <div class="exit-image"><img style="pointer-events: none;" src="../../src/pics/exit.svg"
                                             alt="Выйти из учётной записи"></div>
            </div>
        </div>
        <div class="fieldset-main-container">
            <div class="left-column" id="mainLeftColumn">
                <div class="fieldset-container">
                    <div class="fieldset-inner-container" style="background-image:url(../../src/pics/chart-pic.png);background-position: center;
  background-repeat: no-repeat;
  background-size: cover;">
                    </div>
                    <div class="fieldset-inner-container" style="background-image:url(../../src/pics/random-playlist.jpg);background-position: center;
  background-repeat: no-repeat;
  background-size: cover;">
                    </div>
                </div>
                <div class="fieldset-container">
                    <div class="fieldset-inner-container">
                        <div class="playlist-inner-container" id="1" style="background-color:white; background-image:url(../../src/pics/maksim.jpg);background-position: center;
  background-repeat: no-repeat;
  background-size: cover;">
                        </div>
                        <label for="1">МАКSИМ</label>
                    </div>
                    <div class="fieldset-inner-container">
                        <div class="playlist-inner-container" id="2" style="background-color:white; background-image:url(../../src/pics/dora.jpg);background-position: center;
  background-repeat: no-repeat;
  background-size: cover;">
                        </div>
                        <label for="2">ДОРА</label>
                    </div>
                    <div class="fieldset-inner-container">
                        <div class="playlist-inner-container" id="3" style="background-color:white;;background-image:url(../../src/pics/serega.jpg);background-position: center;
  background-repeat: no-repeat;
  background-size: cover;">
                        </div>
                        <label for="3">ПИРАТ</label>
                    </div>
                    <div class="fieldset-inner-container">
                        <div class="playlist-inner-container" id="4" style="background-color:white; background-image:url(../../src/pics/shaman.jpg);background-position: center;
  background-repeat: no-repeat;
  background-size: cover;">
                        </div>
                        <label for="4">SHAMAN</label>
                    </div>
                </div>
            </div>
            <div class="left-column" id="userLeftColumn" style="display: none">
                <div class="fieldset-container">
                    <div class="fieldset-inner-container">
                        <div class="playlist-inner-container" id="1" style="background-color:white; background-image:url(../../src/pics/dora.jpg);background-position: center;
  background-repeat: no-repeat;
  background-size: cover;">
                        </div>
                        <label for="1">Дора</label>
                    </div>
                    <div class="fieldset-inner-container">
                        <div class="playlist-inner-container" id="2" style="background-color:white; background-image:url(../../src/pics/dora.jpg);background-position: center;
  background-repeat: no-repeat;
  background-size: cover;">
                        </div>
                        <label for="2">Дора</label>
                    </div>
                    <div class="fieldset-inner-container">
                        <div class="playlist-inner-container" id="3" style="background-color:white;;background-image:url(../../src/pics/dora.jpg);background-position: center;
  background-repeat: no-repeat;
  background-size: cover;">
                        </div>
                        <label for="3">Дора</label>
                    </div>
                    <div class="fieldset-inner-container">
                        <div class="playlist-inner-container" id="4" style="background-color:white; background-image:url(../../src/pics/dora.jpg);background-position: center;
  background-repeat: no-repeat;
  background-size: cover;">
                        </div>
                        <label for="4">Дора</label>
                    </div>
                    <div class="fieldset-inner-container">
                        <div class="playlist-inner-container" id="6" style="background-color:white; background-image:url(../../src/pics/dora.jpg);background-position: center;
  background-repeat: no-repeat;
  background-size: cover;">
                        </div>
                        <label for="6">Дора</label>
                    </div>
                    <div class="fieldset-inner-container">
                        <div class="playlist-inner-container" id="7" style="background-color:white; background-image:url(../../src/pics/dora.jpg);background-position: center;
  background-repeat: no-repeat;
  background-size: cover;">
                        </div>
                        <label for="7">Дора</label>
                    </div>
                    <div class="fieldset-inner-container">
                        <div class="playlist-inner-container" id="8" style="background-color:white; background-image:url(../../src/pics/dora.jpg);background-position: center;
  background-repeat: no-repeat;
  background-size: cover;">
                        </div>
                        <label for="8">Дора</label>
                    </div>
                    <div class="fieldset-inner-container">
                        <div class="playlist-inner-container" id="9" style="background-color:white; background-image:url(../../src/pics/dora.jpg);background-position: center;
  background-repeat: no-repeat;
  background-size: cover;">
                        </div>
                        <label for="9">Дора</label>
                    </div>
                    <div class="fieldset-inner-container">
                        <div class="playlist-inner-container" id="10" style="background-color:white; background-image:url(../../src/pics/dora.jpg);background-position: center;
  background-repeat: no-repeat;
  background-size: cover;">
                        </div>
                        <label for="10">Дора</label>
                    </div>
                    <div class="fieldset-inner-container">
                        <div class="playlist-inner-container" id="11" style="background-color:white; background-image:url(../../src/pics/dora.jpg);background-position: center;
  background-repeat: no-repeat;
  background-size: cover;">
                        </div>
                        <label for="11">Дора</label>
                    </div>
                    <div class="fieldset-inner-container">
                        <div class="playlist-inner-container" id="12" style="background-color:white; background-image:url(../../src/pics/dora.jpg);background-position: center;
  background-repeat: no-repeat;
  background-size: cover;">
                        </div>
                        <label for="12">Дора</label>
                    </div>
                    <div class="fieldset-inner-container">
                        <div class="playlist-inner-container" id="13" style="background-color:white; background-image:url(../../src/pics/dora.jpg);background-position: center;
  background-repeat: no-repeat;
  background-size: cover;">
                        </div>
                        <label for="13">Дора</label>
                    </div>
                    <div class="fieldset-inner-container">
                        <div class="playlist-inner-container" id="14" style="background-color:white; background-image:url(../../src/pics/dora.jpg);background-position: center;
  background-repeat: no-repeat;
  background-size: cover;">
                        </div>
                        <label for="14">Дора</label>
                    </div>
                    <div class="fieldset-inner-container">
                        <div class="playlist-inner-container" id="15" style="background-color:white; background-image:url(../../src/pics/dora.jpg);background-position: center;
  background-repeat: no-repeat;
  background-size: cover;">
                        </div>
                        <label for="15">Дора</label>
                    </div>
                    <div class="fieldset-inner-container">
                        <div class="playlist-inner-container" id="16" style="background-color:white; background-image:url(../../src/pics/dora.jpg);background-position: center;
  background-repeat: no-repeat;
  background-size: cover;">
                        </div>
                        <label for="16">Дора</label>
                    </div>
                    <div class="fieldset-inner-container">
                        <div class="playlist-inner-container" id="17" style="background-color:white; background-image:url(../../src/pics/dora.jpg);background-position: center;
  background-repeat: no-repeat;
  background-size: cover;">
                        </div>
                        <label for="17">Дора</label>
                    </div>
                    <div class="fieldset-inner-container">
                        <div class="playlist-inner-container" id="18" style="background-color:white; background-image:url(../../src/pics/dora.jpg);background-position: center;
  background-repeat: no-repeat;
  background-size: cover;">
                        </div>
                        <label for="18">Дора</label>
                    </div>
                    <div class="fieldset-inner-container">
                        <div class="playlist-inner-container" id="19" style="background-color:white; background-image:url(../../src/pics/dora.jpg);background-position: center;
  background-repeat: no-repeat;
  background-size: cover;">
                        </div>
                        <label for="19">Дора</label>
                    </div>
                    <div class="fieldset-inner-container">
                        <div class="playlist-inner-container" id="20" style="background-color:white; background-image:url(../../src/pics/dora.jpg);background-position: center;
  background-repeat: no-repeat;
  background-size: cover;">
                        </div>
                        <label for="20">Дора</label>
                    </div>
                    <div class="fieldset-inner-container">
                        <div class="playlist-inner-container" id="21" style="background-color:white; background-image:url(../../src/pics/dora.jpg);background-position: center;
  background-repeat: no-repeat;
  background-size: cover;">
                        </div>
                        <label for="21">Дора</label>
                    </div>
                </div>
            </div>
            <div class="right-column">
                <div class="loader-container">
                    <div class="loader"></div>
                </div>
                <div class="playlist-container" id="playlistContainer">
                    <div class="playlist-data-container" id="1_track_pl" style="background-color:white; background-image:url(../../src/pics/dora.jpg);background-position: center;
  background-repeat: no-repeat;
  background-size: cover;">
                        <button class="button-yellow play"><span class="play-icon">▶</span></button>
                        <label>Душевный плейлист</label>
                        <button style="position: absolute;top:0;right:0;display:flex;padding-left:2px; align-items: center;justify-content:center"
                                class="button-yellow close" id="close-playlist"><span>✖</span></button>
                    </div>
                    <div class="track-container" id="">
                        <button class="button-yellow play"><span class="play-icon">▶</span></button>
                        <label style="margin-left:0.5rem">Ты задолбал меня игнорить - Дора</label>
                        <button class="button-yellow add" id="add-to-playlist"><img src="../../src/pics/plus.svg"
                                                                                    alt="Добавить в плейлист"></button>
                    </div>
                </div>
            </div>
        </div>
        <div class="player">
            <label for="progress">Ты задолбал меня игнорить - Дора</label>
            <audio id="song">
                <source src="../../src/music/dora.mp3" type="audio/mpeg">
            </audio>
            <input type="range" value="0" id="progress" style="background: #757575;">
            <div class="controls">
                <img class="controls-butt" src="../../src/pics/backward.svg" alt="backward">
                <img class="controls-butt play" style="padding-left:1px" src="../../src/pics/play.svg" alt="play"
                     id="play" onclick="playPause()">
                <img class="controls-butt pause" src="../../src/pics/pause.svg" alt="pause" id="pause" hidden
                     onclick="playPause()">
                <img class="controls-butt" src="../../src/pics/forward.svg" alt="forward">
                <input type="range" value="100" min="0" max="100" id="volume" style="background: #757575">
            </div>
        </div>
    </div>
</div>
<script>

    let progress = document.getElementById("progress");
    let song = document.getElementById("song");
    let volume = document.getElementById("volume")
    song.onloadeddata = function () {
        progress.max = song.duration;
        progress.value = song.currentTime;
        song.volume = 0.4;
        volume.value = 40;
        updateVolumeGradient()
    }

    function playPause() {
        if (document.getElementById("pause").hidden) {
            song.play();
            document.getElementById("pause").removeAttribute("hidden")
            document.getElementById("play").setAttribute("hidden", "hidden")
        } else {
            song.pause();
            document.getElementById("play").removeAttribute("hidden")
            document.getElementById("pause").setAttribute("hidden", "hidden")
        }

    }

    if (song.play()) {
        setInterval(() => {
            progress.value = song.currentTime;
            updateProgressGradient()
        }, 500)
    }

    progress.oninput = function () {
        song.play()
        song.currentTime = progress.value;
        updateProgressGradient();
        document.getElementById("pause").removeAttribute("hidden");
        document.getElementById("play").setAttribute("hidden", "hidden");
    }
    volume.oninput = function () {
        song.volume = volume.value / 100;
        updateVolumeGradient();
    }

    function updateProgressGradient() {
        let value = (progress.value / progress.max) * 100;
        progress.style.background = `linear-gradient(to right, #ffd000 ${value}%, #757575 ${value}%)`;
    }

    function updateVolumeGradient() {
        volume.style.background = `linear-gradient(to right, #ffd000 ${volume.value}%, #757575 ${volume.value}%)`;
    }

    document.addEventListener("DOMContentLoaded", function () {
        const playlistContainers = document.querySelectorAll('.fieldset-inner-container');
        const playlistContainer = document.querySelector('.playlist-container');
        const closePlaylistButton = document.getElementById('close-playlist');
        let isPlaylistOpen = false;

        playlistContainers.forEach(function (container) {
            container.addEventListener('click', function () {
                if (isPlaylistOpen) {
                    playlistContainer.classList.remove('active');

                    // Показываем лоадер
                    document.querySelector('.loader-container').classList.add('active');

                    setTimeout(function () {
                        Promise.race([
                            fetch('/api/get-tracks').then(response => response.json()),
                            new Promise((_, reject) => setTimeout(() => reject(new Error('Время ожидания запроса истекло')), 10000))
                        ])
                            .then(data => {
                                const playlistContainer = document.getElementById('playlistContainer');
                                let htmlContent = '';
                                data.forEach(track => {
                                    htmlContent += `
                            <div class="track-container" id="${track.id}">
                                <button class="button-yellow play"><span class="play-icon">▶</span></button>
                                <label style="margin-left:0.5rem">"${track.name}" - "${track.author}"</label>
                                <button class="button-yellow add" id="play_${track.id}"><img src="../../src/pics/plus.svg" alt="Добавить в плейлист"></button>
                            </div>
                        `;
                                });
                                playlistContainer.innerHTML = htmlContent;
                                const playButtons = document.querySelectorAll('.track-container .play');
                                playButtons.forEach(button => {
                                    button.addEventListener('click', function () {
                                        const trackId = this.closest('.track-container').id;
                                        loadAndPlayTrack(trackId);
                                    });
                                });

                                // Теперь открываем плейлист
                                playlistContainer.classList.add('active');
                                // Убираем лоадер
                                document.querySelector('.loader-container').classList.remove('active');
                            })
                            .catch(error => {
                                alert(error.message); // Показываем ошибку, если запрос занимает слишком много времени
                                document.querySelector('.loader-container').classList.remove('active');
                            });
                    }, 10000);
                } else {
                    // Если плейлист закрыт, показываем лоадер
                    document.querySelector('.loader-container').classList.add('active');

                    setTimeout(() => {
                        Promise.race([
                            fetch('/api/get-tracks').then(response => response.json()),
                            new Promise((_, reject) => setTimeout(() => reject(new Error('Время ожидания запроса истекло')), 10000))
                        ])
                            .then(data => {
                                const playlistContainer = document.getElementById('playlistContainer');
                                let htmlContent = '';
                                data.forEach(track => {
                                    htmlContent += `
                            <div class="track-container" id="${track.id}">
                                <button class="button-yellow play"><span class="play-icon">▶</span></button>
                                <label style="margin-left:0.5rem">"${track.name}" - "${track.author}"</label>
                                <button class="button-yellow add" id="play_${track.id}"><img src="../../src/pics/plus.svg" alt="Добавить в плейлист"></button>
                            </div>
                        `;
                                });
                                playlistContainer.innerHTML = htmlContent;
                                const playButtons = document.querySelectorAll('.track-container .play');
                                playButtons.forEach(button => {
                                    button.addEventListener('click', function () {
                                        const trackId = this.closest('.track-container').id;
                                        loadAndPlayTrack(trackId);
                                    });
                                });

                                // Теперь открываем плейлист
                                playlistContainer.classList.add('active');
                                // Убираем лоадер
                                document.querySelector('.loader-container').classList.remove('active');
                            })
                            .catch(error => {
                                alert(error.message); // Показываем ошибку, если запрос занимает слишком много времени
                                document.querySelector('.loader-container').classList.remove('active');
                            });
                    }, 10000);
                }
                // Обновляем состояние переменной
                isPlaylistOpen = true;
            });
        });

        closePlaylistButton.addEventListener('click', function () {
            // Закрываем плейлист
            playlistContainer.classList.remove('active');
            document.querySelector('.loader-container').classList.remove('active');
            // Сбрасываем состояние переменной
            isPlaylistOpen = false;
        });
    });
    // JavaScript для работы с полем поиска и результатами
    const searchInput = document.getElementById('searchInput');
    const searchDropdown = document.getElementById('searchDropdown');
    const resultsList = document.getElementById('results-list');

    function fillResults(results) {
        resultsList.innerHTML = '';
        results.forEach(result => {
            const li = document.createElement('li');
            resultsList.appendChild(li);
            li.innerHTML = `<div class="track-container" style="display: flex;align-items: center"><button class="button-yellow play" style="width: 36px; height: 36px;"><span class="play-icon">▶</span></button>
            <label style="margin-left:0.5rem;display: flex">${result}</label>
            <button class="button-yellow add"><img style="pointer-events: none;" src="../../src/pics/plus.svg" alt="Добавить в плейлист"></button></div>`
        });
        if (results.length > 0) {
            searchDropdown.classList.add('active');
        } else {
            searchDropdown.classList.remove('active');
        }
    }

    function hideResults() {
        searchDropdown.classList.remove('active');
    }

    searchInput.addEventListener('input', function () {
        const query = this.value.toLowerCase();
        const results = ['Дора', 'Дора1', 'МакSим', 'SHAMAN', 'ПИРАТ'].filter(result => result.toLowerCase().includes(query));
        if (query) {
            fillResults(results);
        } else {
            hideResults();
        }
    });

    document.addEventListener('click', function (event) {
        const isClickInside = searchInput.contains(event.target) || searchDropdown.contains(event.target);
        if (!isClickInside) {
            hideResults();
        }
    });
    let popupBg = document.querySelector('.popup__bg'); // Фон попап окна
    let popup = document.querySelector('.popup'); // Само окно

    document.getElementById('mainContainer')
        .addEventListener('click', event => { // Step 2
            if (event.target.className === 'button-yellow add') { // Step 3
                console.log('click!')
                popupBg.classList.add('active'); // Добавляем класс 'active' для фона
                popup.classList.add('active'); // И для самого окна
            }
        });
    document.addEventListener('click', (e) => { // Вешаем обработчик на весь документ
        if (e.target === popupBg) { // Если цель клика - фот, то:
            popupBg.classList.remove('active'); // Убираем активный класс с фона
            popup.classList.remove('active'); // И с окна
        }
    });
    document.addEventListener('DOMContentLoaded', function () {
        const userImage = document.querySelector('.user-image');
        const logoImage = document.getElementById('logoImage');
        const userPage = document.getElementById('userLeftColumn');
        const mainPage = document.getElementById('mainLeftColumn');

        userImage.addEventListener('click', function () {
            if (userPage.style.display === "none" || userPage.style.display === "") {
                userPage.style.display = "flex";
                mainPage.style.display = "none";
            }
        });
        logoImage.addEventListener('click', function () {
            if (mainPage.style.display === "none" || mainPage.style.display === "") {
                userPage.style.display = "none";
                mainPage.style.display = "flex";
            }
        });
    });

    function loadAndPlayTrack(trackId) {
        fetch(`/api/get-track/${trackId}`, {method: 'GET'}) // API, которое возвращает BLOB аудио
            .then(response => {
                if (response.ok) return response.blob();
                throw new Error('Network response was not ok.');
            })
            .then(blob => {
                const url = URL.createObjectURL(blob);
                const audioPlayer = document.getElementById('song');
                const source = audioPlayer.querySelector('source');
                source.src = url;
                audioPlayer.load();
                playPause();
            })
            .catch(error => console.error('Error fetching or playing the track:', error));
    }

</script>
</body>
</html>